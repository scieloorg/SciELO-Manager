{% extends "base_list_lv0.html" %}
{% load i18n %}
{% load static %}
{% load assets %}
{% load trans_status %}
{% load scielo_common %}
{% load query_string %}
{% load inctag_toolbars %}

{% block page_title %}{% trans "Ticket detail" %}{% endblock %}

{% block content %}

<div class="page-header">
  <h1>
    {% if ticket.is_open %}
      <span class="label label-success">{% trans "Open" %}</span> 
    {% else %}
      <span class="label label-important">{% trans "Closed" %}</span> 
    {% endif %}
    {{ ticket.title|title }} <small>#{{ ticket.pk }}</small>
  </h1>
  <p class='muted'>
    <img style="vertical-align:top;" src="{{ ticket.author.get_profile.avatar_url }}" alt="Gravatar">
    {{ ticket.author.get_full_name }} 
    {% trans "created this ticket on" %}: {{ ticket.started_at|date:"d/m/Y - H:i" }} &bull;
    ({{ ticket.comments.all|length }} {% trans "comments" %})
  </p>
  {% if not ticket.is_open %}
    <div class="alert alert-info">
      <strong>
        <i class="icon-ban-circle"></i> {% trans "The ticket was closed on" %}:
      </strong>
      {{ ticket.started_at|date:"d/m/Y - H:i" }}
    </div>
  {% endif %}
</div>

<div class="row-fluid show-grid">
  <div class="span12">
    <strong>{% trans "Message" %}:</strong><br>
    <blockquote>{{ ticket.message|linebreaksbr }}<blockquote>
  </div>

  {% if ticket.is_open %}
  
    <div id='action_buttons_row'>
      {% if perms.comment.can_add or perms.ticket.can_add %}
        <a id='add_comment' href="#" class="btn btn-success" type="button">
          <i class="icon-plus-sign"></i> {% trans "Add Comment" %}
        </a>
      {% endif %}
      
      {% if perms.ticket.can_change %}

        <a href="{% url ticket_edit ticket.pk %}" class='btn'>
          <i class="icon-pencil"></i> {% trans "Edit" %}
        </a>

        <a id='close_ticket' href="#" class="btn btn-warning pull-right" type="button">
          <i class="icon-remove-circle"></i> {% trans "Close" %}
        </a>

      {% endif %}
    </div>

  {% endif %}

</div>
{% if ticket.is_open %}
	<!-- ADD COMMENT FORM -->
	<div id='add_comment_section_row' class='row hide_row'>
	  <div class="span10 offset1">
			<form action='.' method='POST'>
				{% csrf_token %}
				{{ form }}
				<input type='button' id='discard_comment' class='btn btn-danger pull-left' value='{% trans "Discard" %}'/> 
				<input type='submit' class='btn btn-primary pull-right' value='{% trans "Send" %}'/>
			</form>
	  </div>
	</div>
{% endif %}
<!-- COMMENTS -->
<h4>{% trans "Comments" %}:</h4>
{% for comment in ticket.comments.all %}
  <div class="row-fluid show-grid">
      <div class="span12">
          <blockquote>
              {{ comment.message|linebreaksbr }}
              <small>
                  <img style="vertical-align:top;" src="{{ comment.author.get_profile.avatar_url }}" alt="Gravatar">
                  {{ comment.author.get_full_name }} <i class="icon-time"></i> 
                  <cite title="">{{ comment.date|date:"d/m/Y - H:i" }}</cite>
              </small>
          </blockquote>
          <hr>
      </div>
  </div>
{% empty %}
  <p>{% trans "No comments" %}</p>
{% endfor %}

<!-- NAVIGATIONS -->
<div class="row-fluid show-grid">
	<div class="span12">
	  <div class="btn-group">
	  	<a class="btn disabled">{% trans 'Go to' %}:</a>
	    <a class="btn" href="{% url ticket_list %}"><i class="icon-arrow-left"></i> {% trans "List of tickets" %}</a>
	  </div>
	</div>
</div>
{% endblock %}

{% block extrafooter %}
  <script type="text/javascript">
    $(document).ready(function(){
			$('#add_comment').click(function(event){
				event.preventDefault(); 
				$('#action_buttons_row').hide();
				$('#add_comment_section_row').show();
				$('#id_message').focus();
			});
			$('#discard_comment').click(function(event){
				if (confirm('{% trans "The message of the comment will be unsaved, are you sure?" %}')) {
					window.location.reload();
				}
			});
			$('#close_ticket').click(function(event){
				if (confirm('{% trans "the ticket will be closed, are you sure?" %}')) {
					window.location.href = '{% url ticket_close ticket.pk %}';
				}
			});
		});
	</script>
{% endblock %}